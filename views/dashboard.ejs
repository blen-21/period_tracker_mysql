<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BloomCycle | Period & Fertility Tracker</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    :root {
      --primary: #e83f8e;
      --primary-light: #ff8fab;
      --primary-lighter: #ffc2d1;
      --secondary: #9c4668;
      --light: #fff9fb;
      --white: #ffffff;
      --text: #3a2e37;
      --bloom: linear-gradient(135deg, #e83f8e, #ff8fab);
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --menstrual: #e83f8e;
      --follicular: #ff8fab;
      --ovulation: #ffd166;
      --luteal: #9c4668;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--light);
      color: var(--text);
      line-height: 1.6;
    }

    nav {
      background: var(--white);
      box-shadow: var(--shadow);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }

    .nav-logo {
      font-size: 1.8rem;
      font-weight: 700;
      background: var(--bloom);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-logo i {
      font-size: 1.6rem;
    }

    .nav-links {
      display: flex;
      gap: 30px;
    }

    .nav-links a {
      text-decoration: none;
      color: var(--text);
      font-weight: 500;
      transition: color 0.3s;
      padding: 8px 12px;
      border-radius: 8px;
    }

    .nav-links a:hover {
      color: var(--primary);
      background-color: var(--primary-lighter);
    }

    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .dashboard-header {
      text-align: center;
      margin-bottom: 40px;
      padding: 20px 0;
    }

    .dashboard-header h1 {
      color: var(--primary);
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .dashboard-header p {
      color: var(--secondary);
      font-size: 1.2rem;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    .card {
      background-color: var(--white);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 30px;
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card h2 {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--primary-lighter);
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(232, 63, 142, 0.2);
    }

    .btn {
      background: var(--bloom);
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 10px rgba(232, 63, 142, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(232, 63, 142, 0.4);
    }

    .calendar-container {
      grid-column: 1 / -1;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .month-nav {
      display: flex;
      gap: 10px;
    }

    .month-nav button {
      background: var(--primary-lighter);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .month-nav button:hover {
      background: var(--primary);
      color: white;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }

    .day-header {
      text-align: center;
      font-weight: 600;
      color: var(--secondary);
      padding: 10px;
    }

    .day {
      height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      padding: 5px;
      text-align: center;
      border: 1px solid var(--primary-lighter);
    }

    .day:hover {
      transform: scale(1.05);
    }

    .day.empty {
      background: transparent;
      border: none;
    }

    .day .day-number {
      font-weight: 600;
      margin-bottom: 3px;
    }

    .day .day-label {
      font-size: 0.7rem;
      font-weight: 500;
      padding: 2px 5px;
      border-radius: 4px;
      margin-top: 3px;
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .day.today {
      border: 2px solid var(--primary);
    }

    .day.period-day {
      background: var(--menstrual);
      color: white;
    }

    .day.ovulation-day {
      background: var(--ovulation);
      color: var(--text);
    }

    .day.fertile-day {
      background: var(--follicular);
      color: var(--text);
    }

    .legend {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }

    .mood-tracker-section {
      grid-column: 1 / -1;
    }

    .mood-selector {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .mood {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
      border: 2px solid var(--primary-lighter);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mood:hover {
      border-color: var(--primary);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .mood.selected {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .mood-emoji {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .mood-img {
      width: 40px;
      height: 40px;
      margin-bottom: 8px;
      object-fit: contain;
    }

    .mood-label {
      font-size: 0.9rem;
      text-align: center;
    }

    .date-picker {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .date-picker label {
      font-weight: 500;
    }

    .date-picker input {
      padding: 10px;
      border: 2px solid var(--primary-lighter);
      border-radius: 8px;
    }

    .log {
      margin-top: 30px;
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .log-entries {
      max-height: 300px;
      overflow-y: auto;
    }

    .day-group {
      margin-bottom: 20px;
      border-bottom: 1px solid var(--primary-lighter);
      padding-bottom: 15px;
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .day-date {
      font-weight: 600;
      color: var(--secondary);
    }

    .day-clear {
      background: transparent;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .mood-entry {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 8px 0;
    }

    .mood-time {
      color: var(--secondary);
      font-size: 0.9rem;
      min-width: 80px;
    }

    .mood-emoji {
      font-size: 1.5rem;
    }

    .mood-delete {
      background: transparent;
      border: none;
      color: var(--primary);
      cursor: pointer;
      margin-left: auto;
    }

    .no-entries {
      text-align: center;
      color: var(--secondary);
      padding: 20px;
    }

    .clear-btn {
      background: transparent;
      border: 2px solid var(--primary-light);
      color: var(--primary);
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
    }

    .clear-btn:hover {
      background: var(--primary);
      color: white;
    }

    footer {
      text-align: center;
      padding: 30px;
      color: var(--secondary);
      border-top: 1px solid var(--primary-lighter);
      margin-top: 40px;
    }

    .heart {
      color: var(--primary);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--white);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .stat-label {
      color: var(--secondary);
      font-size: 0.9rem;
    }

    .loading-text {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
.cycle-phase-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 30px;
}

.phase-card {
  padding: 20px;
  border-radius: 15px;
  color: white;
  display: flex;
  flex-direction: column;
  gap: 10px;
  box-shadow: var(--shadow);
  transition: transform 0.3s ease;
}

.phase-card:hover {
  transform: translateY(-5px);
}

.phase-card h3 {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  font-size: 1.1rem;
}

.phase-card p {
  font-size: 0.9rem;
  line-height: 1.5;
}

.phase-symptoms {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-top: 10px;
}

.symptom-tag {
  background: rgba(255, 255, 255, 0.2);
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.7rem;
}

.phase-card.menstrual {
  background: var(--menstrual);
}

.phase-card.follicular {
  background: var(--follicular);
  color: var(--text);
}

.phase-card.ovulation {
  background: var(--ovulation);
  color: var(--text);
}

.phase-card.luteal {
  background: var(--luteal);
}

@media (max-width: 768px) {
  .cycle-phase-info {
    grid-template-columns: 1fr;
  }
}
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .nav-links {
        gap: 15px;
      }
      
      .mood-selector {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
      
      .day {
        height: 60px;
        padding: 2px;
      }
      
      .day .day-label {
        font-size: 0.6rem;
      }
    }

    @media (max-width: 480px) {
      .nav-container {
        flex-direction: column;
        gap: 15px;
      }
      
      .dashboard-header h1 {
        font-size: 2rem;
      }
      
      .card {
        padding: 20px;
      }
      
      .day {
        height: 50px;
      }
      
      .day .day-label {
        display: none;
      }
    }
.discharge-icon {
  font-size: 1.8rem;
  margin-bottom: 8px;
  color: var(--secondary);
}

.mood.selected .discharge-icon {
  color: white;
}
/* Chatbot Styles */
.chatbot-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
}

.chatbot-toggle {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--bloom);
  color: white;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  box-shadow: var(--shadow);
  transition: all 0.3s ease;
}

.chatbot-toggle:hover {
  transform: scale(1.1);
}

.chatbot-window {
  position: absolute;
  bottom: 70px;
  right: 0;
  width: 350px;
  height: 500px;
  background: var(--white);
  border-radius: 20px;
  box-shadow: var(--shadow);
  display: none;
  flex-direction: column;
  overflow: hidden;
}

.chatbot-window.active {
  display: flex;
}

.chatbot-header {
  background: var(--bloom);
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chatbot-header h3 {
  margin: 0;
  font-size: 1.1rem;
}

.chatbot-close {
  background: none;
  border: none;
  color: white;
  font-size: 1.2rem;
  cursor: pointer;
}

.chatbot-messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.message {
  max-width: 80%;
  padding: 12px 16px;
  border-radius: 18px;
  line-height: 1.4;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message.user {
  align-self: flex-end;
  background: var(--primary);
  color: white;
  border-bottom-right-radius: 5px;
}

.message.bot {
  align-self: flex-start;
  background: var(--primary-lighter);
  color: var(--text);
  border-bottom-left-radius: 5px;
}

.chatbot-input {
  padding: 15px 20px;
  border-top: 1px solid var(--primary-lighter);
  display: flex;
  gap: 10px;
  background: var(--white);
}

.chatbot-input input {
  flex: 1;
  padding: 12px 16px;
  border: 2px solid var(--primary-lighter);
  border-radius: 25px;
  outline: none;
  font-size: 0.9rem;
}

.chatbot-input input:focus {
  border-color: var(--primary);
}

.chatbot-input button {
  background: var(--primary);
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.chatbot-input button:hover:not(:disabled) {
  background: var(--secondary);
  transform: scale(1.05);
}

.chatbot-input button:disabled {
  background: var(--primary-lighter);
  cursor: not-allowed;
}

.typing-indicator {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 12px 16px;
  background: var(--primary-lighter);
  border-radius: 18px;
  border-bottom-left-radius: 5px;
  align-self: flex-start;
}

.typing-dot {
  width: 8px;
  height: 8px;
  background: var(--secondary);
  border-radius: 50%;
  animation: typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
  0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
  40% { transform: scale(1); opacity: 1; }
}

.welcome-message {
  text-align: center;
  color: var(--secondary);
  font-size: 0.9rem;
  margin-bottom: 10px;
}
  </style>
</head>
<body>
  <nav>
    <div class="nav-container">
      <div class="nav-logo">
        <i class="fas fa-venus"></i>
        BloomCycle
      </div>
      <div class="nav-links">
        <a href="#"><i class="fas fa-home"></i> Dashboard</a>
        <a href="/calculators"><i class="fas fa-calculator"></i> Calculators</a>
        <a href="#"><i class="fas fa-cog"></i> Settings</a>
        <a href="/posts"><i class="fas fa-question"></i> Community Forum</a>
         <a href="/logout">Log Out</a>
      </div>
    </div>
  </nav>

  <div class="dashboard-container">
    <div class="dashboard-header">
      <h1><%= username %>, Welcome to Your Cycle Dashboard</h1>
      <p>Track your period, fertility, and symptoms all in one place</p>

    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">5</div>
        <div class="stat-label">Days until period</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">12</div>
        <div class="stat-label">Cycle day</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">28</div>
        <div class="stat-label">Cycle length</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">Medium</div>
        <div class="stat-label">Flow today</div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="card">
        <h2><i class="fas fa-calendar-alt"></i> Cycle Tracking</h2>
        <div class="form-group">
          <label for="start-date"><i class="fas fa-calendar-day"></i> Start date of your last period</label>
          <input type="date" id="start-date">
        </div>
        <div class="form-group">
          <label for="cycle-length"><i class="fas fa-arrows-alt-h"></i> Your average cycle length (days)</label>
          <input type="number" id="cycle-length" value="28" min="21" max="45">
        </div>
        <div class="form-group">
          <label for="luteal-phase"><i class="fas fa-ruler"></i> Luteal phase length (days, typically 14)</label>
          <input type="number" id="luteal-phase" value="14" min="10" max="18">
        </div>
        <button class="btn" id="calculate-btn" onclick="handleCalculate()">
          <i class="fas fa-magic"></i> Calculate My Cycle
        </button>
      </div>

      <div class="card">
        <h2><i class="fas fa-chart-pie"></i> Current Status</h2>
        <div style="text-align: center; margin: 20px 0;">
          <div style="font-size: 3rem; color: var(--follicular); margin-bottom: 10px;">
            <i class="fas fa-seedling"></i>
          </div>
          <h3 style="color: var(--secondary); margin-bottom: 10px;">Follicular Phase</h3>
          <p>Your body is preparing for ovulation. Energy levels may be increasing.</p>
        </div>
        <div style="margin-top: 20px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>Next Period:</span>
            <span style="font-weight: 600;">June 28, 2025</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>Fertile Window:</span>
            <span style="font-weight: 600;">June 10-16, 2025</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>Ovulation:</span>
            <span style="font-weight: 600;">June 14, 2025</span>
          </div>
        </div>
      </div>

      <div class="card calendar-container">
        <div class="calendar-header">
          <h2><i class="fas fa-calendar"></i> <span id="monthYear">June 2025</span></h2>
          <div class="month-nav">
            <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>

        <div class="calendar-grid" id="calendar-header">
          <div class="day-header">Sun</div>
          <div class="day-header">Mon</div>
          <div class="day-header">Tue</div>
          <div class="day-header">Wed</div>
          <div class="day-header">Thu</div>
          <div class="day-header">Fri</div>
          <div class="day-header">Sat</div>
        </div>

        <div class="calendar-grid" id="calendar">
          <!-- Calendar days will be generated here -->
        </div>

        <div class="legend">
          <div class="legend-item">
            <div class="legend-color" style="background: var(--menstrual);"></div>
            <span>Period Days</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--ovulation);"></div>
            <span>Ovulation Day</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--follicular);"></div>
            <span>Fertile Window</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: transparent; border: 2px solid var(--primary);"></div>
            <span>Today</span>
          </div>
        </div>
      </div>
<div class="cycle-phase-info">
  <div class="phase-card menstrual">
    <h3><i class="fas fa-tint"></i> Menstrual Phase</h3>
    <p>Days 1-5: Your period. The uterus sheds its lining.</p>
    <div class="phase-symptoms">
      <span class="symptom-tag">Cramps</span>
      <span class="symptom-tag">Fatigue</span>
      <span class="symptom-tag">Bloating</span>
    </div>
  </div>
  <div class="phase-card follicular">
    <h3><i class="fas fa-seedling"></i> Follicular Phase</h3>
    <p>Days 6-13: Your body prepares for ovulation. Energy increases.</p>
    <div class="phase-symptoms">
      <span class="symptom-tag">Rising energy</span>
      <span class="symptom-tag">Clear skin</span>
      <span class="symptom-tag">High motivation</span>
    </div>
  </div>
  <div class="phase-card ovulation">
    <h3><i class="fas fa-egg"></i> Ovulation</h3>
    <p>Day 14: An egg is released. This is your most fertile time.</p>
    <div class="phase-symptoms">
      <span class="symptom-tag">Increased libido</span>
      <span class="symptom-tag">Ovulation pain</span>
      <span class="symptom-tag">Fertile mucus</span>
    </div>
  </div>
  <div class="phase-card luteal">
    <h3><i class="fas fa-leaf"></i> Luteal Phase</h3>
    <p>Days 15-28: Your body prepares for a possible pregnancy.</p>
    <div class="phase-symptoms">
      <span class="symptom-tag">PMS</span>
      <span class="symptom-tag">Food cravings</span>
      <span class="symptom-tag">Mood swings</span>
    </div>
  </div>
</div>

      <div class="card mood-tracker-section">
        <h2><i class="fas fa-smile"></i> Mood & Symptom Tracker</h2>
        
        <div class="date-picker">
          <label for="date">Select Date:</label>
          <input type="date" id="date">
        </div>

        <h3>Moods</h3>
        <div class="mood-selector">
          <div class="mood" data-mood="üòä">
            <div class="mood-emoji">üòä</div>
            <span class="mood-label">Happy</span>
          </div>
          <div class="mood" data-mood="üòê">
            <div class="mood-emoji">üòê</div>
            <span class="mood-label">Meh</span>
          </div>
          <div class="mood" data-mood="üò¢">
            <div class="mood-emoji">üò¢</div>
            <span class="mood-label">Sad</span>
          </div>
          <div class="mood" data-mood="üò†">
            <div class="mood-emoji">üò†</div>
            <span class="mood-label">Angry</span>
          </div>
        </div>

        <h1>Symptoms</h1>
  <div class="mood-selector">
    <div class="mood" data-mood="Everything is Fine">
      <img src="images/thumb-up.png" alt="fine" class="mood-img">
      <span class="mood-label">Everything is Fine</span>
    </div>
    <div class="mood" data-mood="Headache">
      <img src="images/headache.png" alt="Headache" class="mood-img">
      <span class="mood-label">Headache</span>
    </div>
    <div class="mood" data-mood="Stomach Ache">
      <img src="images/stomach.png" alt="Stomach Ache" class="mood-img">
      <span class="mood-label">Stomach Ache</span>
    </div>
    <div class="mood" data-mood="Insomnia">
      <img src="images/pillow.png" alt="Insomnia" class="mood-img">
      <span class="mood-label">Insomnia</span>
    </div>
    <div class="mood" data-mood="Acne">
      <img src="images/acne.png" alt="acne" class="mood-img">
      <span class="mood-label">Acne</span>
    </div>
    <div class="mood" data-mood="Tender Breasts">
      <img src="images/tender-breasts.png" alt="tender-breasts" class="mood-img">
      <span class="mood-label">Tender Breasts</span>
    </div>
    <div class="mood" data-mood="Backache">
      <img src="images/back.png" alt="back-ache" class="mood-img">
      <span class="mood-label">Backache</span>
    </div>
    <div class="mood" data-mood="Fatigue">
      <img src="images/low-battery.png" alt="fatigue" class="mood-img">
      <span class="mood-label">Fatigue</span>
    </div>
    <div class="mood" data-mood="cravings">
      <img src="images/hamburger.png" alt="cravings" class="mood-img">
      <span class="mood-label">Cravings</span>
    </div>
  </div>

  <h1>Digestion and Stool</h1>
  <div class="mood-selector">
    <div class="mood" data-mood="Nausea">
      <img src="images/nausea.png" alt="nausea" class="mood-img">
      <span class="mood-label">Nausea</span>
    </div>
    <div class="mood" data-mood="Diarrhea">
      <img src="images/roll.png" alt="roll" class="mood-img">
      <span class="mood-label">Diarrhea</span>
    </div>
    <div class="mood" data-mood="Bloating">
      <img src="images/bloating.png" alt="bloating" class="mood-img">
      <span class="mood-label">Bloating</span>
    </div>
    <div class="mood" data-mood="Constipation">
      <img src="images/constipation.png" alt="constipation" class="mood-img">
      <span class="mood-label">Constipation</span>
    </div>
  </div>

<h1>Vaginal Discharge</h1>
<div class="mood-selector">
  <div class="mood" data-mood="No Discharge">
    <i class="fas fa-ban discharge-icon"></i>
    <span class="mood-label">No Discharge</span>
  </div>
  <div class="mood" data-mood="Dry">
    <i class="fas fa-wind discharge-icon"></i>
    <span class="mood-label">Dry</span>
  </div>
  <div class="mood" data-mood="Sticky">
    <i class="fas fa-sticky-note discharge-icon"></i>
    <span class="mood-label">Sticky</span>
  </div>
  <div class="mood" data-mood="Creamy">
    <i class="fas fa-cloud discharge-icon"></i>
    <span class="mood-label">Creamy</span>
  </div>
  <div class="mood" data-mood="Egg White">
    <i class="fas fa-egg discharge-icon"></i>
    <span class="mood-label">Egg White</span>
  </div>
  <div class="mood" data-mood="Watery">
    <i class="fas fa-tint discharge-icon"></i>
    <span class="mood-label">Watery</span>
  </div>
</div>

<h1>Pregnancy Test</h1>
<div class="mood-selector">
  <div class="mood" data-mood="Didn't Take Test">
    <i class="fas fa-times-circle discharge-icon"></i>
    <span class="mood-label">Didn't Take Test</span>
  </div>
  <div class="mood" data-mood="Negative">
    <i class="fas fa-minus-circle discharge-icon"></i>
    <span class="mood-label">Negative</span>
  </div>
  <div class="mood" data-mood="Positive">
    <i class="fas fa-plus-circle discharge-icon"></i>
    <span class="mood-label">Positive</span>
  </div>
</div>
<h1>Physical Activity</h1>
<div class="mood-selector">
  <div class="mood" data-mood="Didn't Exercise">
    <i class="fas fa-bed discharge-icon"></i>
    <span class="mood-label">Didn't Exercise</span>
  </div>
  <div class="mood" data-mood="Yoga">
    <i class="fas fa-spa discharge-icon"></i>
    <span class="mood-label">Yoga</span>
  </div>
  <div class="mood" data-mood="Gym">
    <i class="fas fa-dumbbell discharge-icon"></i>
    <span class="mood-label">Gym</span>
  </div>
  <div class="mood" data-mood="Aerobics">
    <i class="fas fa-heartbeat discharge-icon"></i>
    <span class="mood-label">Aerobics</span>
  </div>
  <div class="mood" data-mood="Swimming">
    <i class="fas fa-swimmer discharge-icon"></i>
    <span class="mood-label">Swimming</span>
  </div>
  <div class="mood" data-mood="Running">
    <i class="fas fa-running discharge-icon"></i>
    <span class="mood-label">Running</span>
  </div>
  <div class="mood" data-mood="Walking">
    <i class="fas fa-walking discharge-icon"></i>
    <span class="mood-label">Walking</span>
  </div>
</div>
        <div class="log">
          <div class="log-header">
            <h3>Your Mood & Symptom History</h3>
            <button class="clear-btn" id="clear-btn">
              <i class="fas fa-trash-alt"></i> Clear All
            </button>
          </div>
          <div class="log-entries" id="log-entries"></div>
        </div>
      </div>
    </div>
  </div>
<!-- Gemini AI Chatbot -->
<div class="chatbot-container">
  <div class="chatbot-window" id="chatbotWindow">
    <div class="chatbot-header">
      <h3><i class="fas fa-robot"></i> BloomCycle Assistant</h3>
      <button class="chatbot-close" id="chatbotClose">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="chatbot-messages" id="chatbotMessages">
      <div class="welcome-message">
        Hi! I'm your BloomCycle assistant. Ask me about periods, pregnancy, symptoms, or anything else!
      </div>
      <div class="message bot">
        Hello! I'm here to help with any questions about your cycle, pregnancy, or health. What would you like to know? üíñ
      </div>
    </div>
    <div class="chatbot-input">
      <input type="text" id="chatbotInput" placeholder="Ask me anything..." maxlength="500">
      <button id="chatbotSend">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
  <button class="chatbot-toggle" id="chatbotToggle">
    <i class="fas fa-robot"></i>
  </button>
</div>
  <footer>
    <p>Made with <span class="heart">‚ô•</span> for all menstruators | BloomCycle</p>
  </footer>
</body>
  <script>
// Calendar functionality with predictions
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

// Arrays to store multiple cycle predictions
let predictedPeriodStarts = [];
let ovulationDates = [];
let fertileWindows = [];

// Pregnancy tracking
let pregnancyDueDate = null;
let isPregnant = false;

// Mood tracker functionality
const dateInput = document.getElementById("date");
const moodButtons = document.querySelectorAll(".mood");
const logEntries = document.getElementById("log-entries");
const clearBtn = document.getElementById("clear-btn");
const MOOD_DB_KEY = 'bloomcycle-mood-database';

// ADDED: Calculation data storage key
const CALCULATION_DATA_KEY = 'bloomcycle-calculation-data';

// Chatbot elements
const chatbotToggle = document.getElementById('chatbotToggle');
const chatbotWindow = document.getElementById('chatbotWindow');
const chatbotClose = document.getElementById('chatbotClose');
const chatbotMessages = document.getElementById('chatbotMessages');
const chatbotInput = document.getElementById('chatbotInput');
const chatbotSend = document.getElementById('chatbotSend');

// Gemini API configuration
const GEMINI_API_KEY = 'AIzaSyDw1vDfD8cv9koPmIEHp-SmypJL7wfgsAg';
const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

// Initialize the app
window.onload = function () {
  document.getElementById("start-date").valueAsDate = new Date();
  checkPregnancyStatus();
  initDatabase();
  setDefaultDate();
  updateLog();
  initChatbot();
  syncExistingMoodsToMySQL();
  
  // ADDED: Restore calculation data
  restoreCalculationData();
  renderCalendar();
};

// ADDED: Save calculation data to localStorage
function saveCalculationDataToLocalStorage() {
  const calculationData = {
    startDate: document.getElementById("start-date").value,
    cycleLength: document.getElementById("cycle-length").value,
    lutealPhase: document.getElementById("luteal-phase").value,
    predictedPeriodStarts: predictedPeriodStarts.map(date => date.toISOString()),
    ovulationDates: ovulationDates.map(date => date.toISOString()),
    fertileWindows: fertileWindows.map(window => ({
      start: window.start.toISOString(),
      end: window.end.toISOString()
    })),
    currentMonth: currentMonth,
    currentYear: currentYear
  };
  
  localStorage.setItem(CALCULATION_DATA_KEY, JSON.stringify(calculationData));
}

// ADDED: Restore calculation data from localStorage
function restoreCalculationData() {
  try {
    const savedData = localStorage.getItem(CALCULATION_DATA_KEY);
    if (!savedData) return;

    const calculationData = JSON.parse(savedData);

    // Restore form inputs
    if (calculationData.startDate) {
      document.getElementById("start-date").value = calculationData.startDate;
    }
    if (calculationData.cycleLength) {
      document.getElementById("cycle-length").value = calculationData.cycleLength;
    }
    if (calculationData.lutealPhase) {
      document.getElementById("luteal-phase").value = calculationData.lutealPhase;
    }

    // Restore prediction arrays
    if (calculationData.predictedPeriodStarts) {
      predictedPeriodStarts = calculationData.predictedPeriodStarts.map(dateStr => new Date(dateStr));
    }
    if (calculationData.ovulationDates) {
      ovulationDates = calculationData.ovulationDates.map(dateStr => new Date(dateStr));
    }
    if (calculationData.fertileWindows) {
      fertileWindows = calculationData.fertileWindows.map(window => ({
        start: new Date(window.start),
        end: new Date(window.end)
      }));
    }

    // Restore calendar state
    if (calculationData.currentMonth !== undefined) {
      currentMonth = calculationData.currentMonth;
    }
    if (calculationData.currentYear !== undefined) {
      currentYear = calculationData.currentYear;
    }

  } catch (error) {
    console.error('Error restoring calculation data:', error);
  }
}

// Chatbot functionality
function initChatbot() {
  if (!chatbotToggle) return;
  
  chatbotToggle.addEventListener('click', () => {
    chatbotWindow.classList.toggle('active');
  });

  chatbotClose.addEventListener('click', () => {
    chatbotWindow.classList.remove('active');
  });

  chatbotSend.addEventListener('click', sendMessage);

  chatbotInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  addQuickQuestions();
}

function addQuickQuestions() {
  const quickQuestions = [
    "What are common period symptoms?",
    "How to track ovulation?",
    "Pregnancy early signs?",
    "Best exercises during period?"
  ];

  const quickQuestionsHTML = quickQuestions.map(question => 
    `<div class="message bot quick-question" style="cursor: pointer; border: 1px solid var(--primary-light); margin: 5px 0; padding: 8px 12px; border-radius: 15px; font-size: 0.8rem;" onclick="addUserMessage('${question}')">
      ${question}
    </div>`
  ).join('');

  const quickQuestionsContainer = document.createElement('div');
  quickQuestionsContainer.innerHTML = quickQuestionsHTML;
  chatbotMessages.appendChild(quickQuestionsContainer);
}

function addUserMessage(message) {
  const messageElement = document.createElement('div');
  messageElement.className = 'message user';
  messageElement.textContent = message;
  chatbotMessages.appendChild(messageElement);
  chatbotInput.value = '';
  scrollToBottom();
  
  showTypingIndicator();
  sendToGeminiAPI(message);
}

function sendMessage() {
  const message = chatbotInput.value.trim();
  if (message) {
    addUserMessage(message);
  }
}

function showTypingIndicator() {
  const typingElement = document.createElement('div');
  typingElement.className = 'typing-indicator';
  typingElement.id = 'typingIndicator';
  typingElement.innerHTML = `
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
  `;
  chatbotMessages.appendChild(typingElement);
  scrollToBottom();
}

function hideTypingIndicator() {
  const typingIndicator = document.getElementById('typingIndicator');
  if (typingIndicator) {
    typingIndicator.remove();
  }
}

function addBotMessage(message) {
  hideTypingIndicator();
  const messageElement = document.createElement('div');
  messageElement.className = 'message bot';
  messageElement.innerHTML = formatBotResponse(message);
  chatbotMessages.appendChild(messageElement);
  scrollToBottom();
}

function formatBotResponse(text) {
  return text.replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
}

function scrollToBottom() {
  chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
}

async function sendToGeminiAPI(userMessage) {
  try {
    console.log('üöÄ Calling Gemini 2.0 Flash API...');
    
    const prompt = `You are BloomCycle AI, a friendly and empathetic women's health assistant. You help with menstrual cycles, pregnancy, symptoms, and general women's wellness.

User's question: ${userMessage}

Please provide a helpful, accurate, and supportive response. Focus on women's health topics. Be compassionate and informative. Keep responses conversational and under 300 words.`;

    console.log('üì§ Sending request to Gemini API...');
    
    const response = await fetch(GEMINI_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: prompt
          }]
        }],
        generationConfig: {
          maxOutputTokens: 800,
          temperature: 0.7
        }
      })
    });

    console.log('üì• Response status:', response.status);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('‚ùå API Error:', response.status, errorText);
      throw new Error(`API request failed: ${response.status}`);
    }

    const data = await response.json();
    console.log('‚úÖ API Success! Received response');
    
    const botResponse = data.candidates[0].content.parts[0].text;
    console.log('üí¨ Bot response:', botResponse);
    
    addBotMessage(botResponse);
    
  } catch (error) {
    console.error('üí• Error calling Gemini API:', error);
    
    const lowerMessage = userMessage.toLowerCase();
    
    if (/(hi|hello|hey)/.test(lowerMessage)) {
      addBotMessage("Hello! üëã I'm BloomCycle AI, your women's health assistant! I'm here to help with period tracking, pregnancy questions, cycle information, and general wellness. What would you like to know today? üíñ");
    } else if (/(period|menstrual)/.test(lowerMessage)) {
      addBotMessage("I can help with period and cycle questions! üå∏ The average cycle is 28 days, but normal can range from 21-35 days. You can track your cycle in the calendar above and log symptoms in the tracker. Common period symptoms include cramps, bloating, fatigue, and mood changes.");
    } else if (/(pregnant|pregnancy)/.test(lowerMessage)) {
      addBotMessage("Congratulations on your pregnancy journey! üéâ Pregnancy typically lasts 40 weeks. Early signs can include missed periods, nausea, fatigue, and breast tenderness. You can track your pregnancy progress in the calendar above once you log a positive test!");
    } else if (/(ovulation|fertile)/.test(lowerMessage)) {
      addBotMessage("Ovulation tracking is key for understanding fertility! üìä Ovulation usually occurs about 14 days before your next period. Your fertile window is typically 5-6 days leading up to ovulation. The calendar above shows your predicted fertile days based on your cycle data.");
    } else {
      addBotMessage("Thanks for your message! üíï I'm here to help with women's health topics like periods, pregnancy, cycle tracking, symptoms, and general wellness. What specific question can I help you with today?");
    }
  }
}

function getCycleContext() {
  const db = JSON.parse(localStorage.getItem(MOOD_DB_KEY)) || [];
  const recentSymptoms = db.slice(-5).map(entry => entry.mood).join(', ');
  
  let context = "The user is using a period and fertility tracking app. ";
  
  if (isPregnant) {
    const weeksPregnant = Math.floor((280 - Math.ceil((pregnancyDueDate - new Date()) / (24 * 60 * 60 * 1000))) / 7);
    context += `They are currently ${weeksPregnant} weeks pregnant. `;
  }
  
  if (recentSymptoms) {
    context += `Recent tracked symptoms/moods: ${recentSymptoms}. `;
  }
  
  return context;
}

// Prediction functions
async function handleCalculate() {
  const calculateBtn = document.getElementById("calculate-btn");
  const originalBtnText = calculateBtn.innerHTML;
  
  // Show loading state
  calculateBtn.innerHTML = `
    <div class="loading-text">
      <div class="loading-spinner"></div>
      Calculating...
    </div>
  `;
  calculateBtn.disabled = true;
  
  try {
    await new Promise(resolve => setTimeout(resolve, 800));
    await predictCycle();
    await saveCycleDataToMySQL();
  } catch (error) {
    console.error("Error calculating cycle:", error);
    document.getElementById("results").innerHTML = `
      <p>An error occurred while calculating your cycle. Please try again.</p>
    `;
  } finally {
    calculateBtn.innerHTML = originalBtnText;
    calculateBtn.disabled = false;
  }
}

// UPDATED: Save cycle data to MySQL using your cycles table schema
async function saveCycleDataToMySQL() {
  try {
    const startDateInput = document.getElementById("start-date").value;
    const cycleLength = parseInt(document.getElementById("cycle-length").value);
    const lutealPhase = parseInt(document.getElementById("luteal-phase").value);

    if (!startDateInput || isNaN(cycleLength) || isNaN(lutealPhase)) {
      console.log('Skipping MySQL save: Invalid inputs');
      return;
    }

    // Calculate end date (assuming 5-day period)
    const startDate = new Date(startDateInput);
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 5);

    const cycleData = {
      start_date: startDateInput,
      end_date: endDate.toISOString().split('T')[0],
      cycle_length: cycleLength,
      symptoms: JSON.stringify(getRecentSymptoms()),
      mood: getRecentMood(),
      notes: `Luteal phase: ${lutealPhase} days`
    };

    console.log('üì§ Sending cycle data to MySQL:', cycleData);

    const response = await fetch('/api/cycles', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(cycleData)
    });

    console.log('üì• Response status:', response.status);

    if (!response.ok) {
      throw new Error(`Server returned ${response.status}: ${response.statusText}`);
    }

    const result = await response.json();
    console.log('‚úÖ Cycle data saved to MySQL:', result);

  } catch (error) {
    console.error('üí• Error saving cycle data to MySQL:', error);
  }
}

// Helper function to get recent symptoms
function getRecentSymptoms() {
  const db = JSON.parse(localStorage.getItem(MOOD_DB_KEY)) || [];
  const recentSymptoms = db
    .filter(entry => {
      const categories = ["symptom", "discharge", "pregnancy_test", "physical_activity"];
      return categories.some(cat => entry.category === cat);
    })
    .slice(-10)
    .map(entry => entry.mood);
  return recentSymptoms;
}

// Helper function to get recent mood
function getRecentMood() {
  const db = JSON.parse(localStorage.getItem(MOOD_DB_KEY)) || [];
  const moodEntry = db
    .filter(entry => entry.category === "mood")
    .slice(-1)[0];
  return moodEntry ? moodEntry.mood : "neutral";
}

function predictCycle() {
  return new Promise((resolve) => {
    if (isPregnant) {
      renderCalendar();
      resolve();
      return;
    }

    const startDateInput = document.getElementById("start-date").value;
    const loggedMoods = JSON.parse(localStorage.getItem('bloomcycle-mood-database')) || [];
    const symptomEntries = loggedMoods
      .map(entry => entry.mood.toLowerCase())
      .filter(symptom => ["tender breasts", "bloating"].includes(symptom));

    let adjustmentDays = 0;
    if (symptomEntries.includes("tender breasts")) {
      adjustmentDays = 2; 
    } else if (symptomEntries.includes("bloating")) {
      adjustmentDays = 1; 
    }

    const cycleLength = parseInt(document.getElementById("cycle-length").value);
    const lutealPhase = parseInt(document.getElementById("luteal-phase").value);
    const resultDiv = document.getElementById("results");

    if (!startDateInput || isNaN(cycleLength) || isNaN(lutealPhase)) {
      resultDiv.innerHTML = "<p>Please enter all required fields.</p>";
      resolve();
      return;
    }

    const startDate = new Date(startDateInput);
    const maxDate = new Date();
    maxDate.setMonth(maxDate.getMonth() + 24);

    predictedPeriodStarts = [];
    ovulationDates = [];
    fertileWindows = [];

    const options = { year: "numeric", month: "long", day: "numeric" };

    let cycle = 1;
    let currentDate = new Date(startDate);

    while (true) {
      const periodStart = new Date(currentDate);
      periodStart.setDate(currentDate.getDate() + cycleLength - adjustmentDays);

      if (periodStart > maxDate) break;

      predictedPeriodStarts.push(periodStart);

      const ovulation = new Date(periodStart);
      ovulation.setDate(periodStart.getDate() - lutealPhase);
      ovulationDates.push(ovulation);

      const fertileStart = new Date(ovulation);
      fertileStart.setDate(ovulation.getDate() - 6); 
      const fertileEnd = new Date(ovulation);
      fertileEnd.setDate(ovulation.getDate() - 1);
      fertileWindows.push({ start: fertileStart, end: fertileEnd });

      currentDate = periodStart;
      cycle++;
    }

    currentMonth = predictedPeriodStarts[0].getMonth();
    currentYear = predictedPeriodStarts[0].getFullYear();
    renderCalendar();
    
    // ADDED: Save to localStorage after calculation
    saveCalculationDataToLocalStorage();
    
    resolve();
  });
}

function changeMonth(offset) {
  currentMonth += offset;
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  } else if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }
  renderCalendar();
  
  // ADDED: Save calendar state when changing months
  saveCalculationDataToLocalStorage();
}

function renderCalendar() {
  const calendar = document.getElementById("calendar");
  const monthYear = document.getElementById("monthYear");
  calendar.innerHTML = "";

  if (isPregnant && pregnancyDueDate) {
    renderPregnancyCalendar(calendar, monthYear);
    return;
  }

  const date = new Date(currentYear, currentMonth);
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  const today = new Date();

  monthYear.textContent = date.toLocaleString("default", { month: "long", year: "numeric" });

  for (let i = 0; i < firstDay; i++) {
    calendar.innerHTML += `<div class="day empty"></div>`;
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const dateObj = new Date(currentYear, currentMonth, day);
    let classes = "day";
    let label = "";
    let icon = "";

    if (dateObj.toDateString() === today.toDateString()) {
      classes += " today";
    }

    let isOvulation = ovulationDates.some(ov => datesEqual(dateObj, ov));

    for (const start of predictedPeriodStarts) {
      for (let i = 0; i < 5; i++) {
        const periodDay = new Date(start);
        periodDay.setDate(start.getDate() + i);
        if (datesEqual(dateObj, periodDay)) {
          classes += " period-day";
          label = "Period";
          icon = "<i class='fas fa-moon'></i>";
          break;
        }
      }
      if (label) break;
    }

    if (!label && isOvulation) {
      classes += " ovulation-day";
      label = "Ovulation";
      icon = "<i class='fas fa-egg'></i>";
    }

    if (!label) {
      for (const window of fertileWindows) {
        if (dateObj >= window.start && dateObj <= window.end) {
          classes += " fertile-day";
          label = "Fertile";
          icon = "<i class='fas fa-seedling'></i>";
          break;
        }
      }
    }

    calendar.innerHTML += `
      <div class="${classes}">
        <div class="day-number">${day}</div>
        ${label ? `<div class="day-label">${icon} ${label}</div>` : ""}
      </div>
    `;
  }
}

function renderPregnancyCalendar(calendar, monthYear) {
  const today = new Date();
  const date = new Date(currentYear, currentMonth);
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  const weeksPregnant = Math.floor((today - new Date(today.getFullYear(), today.getMonth(), today.getDate() - 280 + pregnancyDueDate.getDate())) / (7 * 24 * 60 * 60 * 1000));
  const daysUntilDue = Math.ceil((pregnancyDueDate - today) / (24 * 60 * 60 * 1000));
  
  monthYear.innerHTML = `Pregnancy: ${weeksPregnant} Weeks | ${daysUntilDue} Days to Go`;

  for (let i = 0; i < firstDay; i++) {
    calendar.innerHTML += `<div class="day empty"></div>`;
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const dateObj = new Date(currentYear, currentMonth, day);
    let classes = "day";
    let label = "";
    let icon = "";

    if (dateObj.toDateString() === today.toDateString()) {
      classes += " today";
      label = "Today";
      icon = "<i class='fas fa-star'></i>";
    }

    if (datesEqual(dateObj, pregnancyDueDate)) {
      classes += " ovulation-day";
      label = "Due Date!";
      icon = "<i class='fas fa-baby'></i>";
    }

    const daysFromStart = Math.floor((dateObj - new Date(pregnancyDueDate.getFullYear(), pregnancyDueDate.getMonth(), pregnancyDueDate.getDate() - 280)) / (24 * 60 * 60 * 1000));
    if (daysFromStart > 0 && daysFromStart % 28 === 0 && !label) {
      const weeks = daysFromStart / 7;
      classes += " fertile-day";
      label = `Week ${weeks}`;
      icon = "<i class='fas fa-heart'></i>";
    }

    calendar.innerHTML += `
      <div class="${classes}">
        <div class="day-number">${day}</div>
        ${label ? `<div class="day-label">${icon} ${label}</div>` : ""}
      </div>
    `;
  }

  updatePregnancyLegend();
}

function updatePregnancyLegend() {
  const legend = document.querySelector('.legend');
  legend.innerHTML = `
    <div class="legend-item">
      <div class="legend-color" style="background: var(--ovulation);"></div>
      <span>Due Date</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: var(--fertile-day);"></div>
      <span>Weekly Milestone</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: transparent; border: 2px solid var(--primary);"></div>
      <span>Today</span>
    </div>
  `;
}

function datesEqual(date1, date2) {
  return (
    date1.getFullYear() === date2.getFullYear() &&
    date1.getMonth() === date2.getMonth() &&
    date1.getDate() === date2.getDate()
  );
}

function checkPregnancyStatus() {
  const db = JSON.parse(localStorage.getItem(MOOD_DB_KEY)) || [];
  const positiveTest = db.find(entry => entry.mood === "Positive");
  
  if (positiveTest) {
    isPregnant = true;
    const testDate = new Date(positiveTest.date);
    pregnancyDueDate = new Date(testDate);
    pregnancyDueDate.setDate(testDate.getDate() + 280);
    
    document.querySelector('.dashboard-header h1').innerHTML = 
      `<i class="fas fa-baby"></i> <%= username %>, Welcome to Your Pregnancy Journey`;
    document.querySelector('.dashboard-header p').textContent = 
      'Track your pregnancy journey and countdown to your due date';
  }
}

// Mood tracker functions
function initDatabase() {
  if (!localStorage.getItem(MOOD_DB_KEY)) {
    localStorage.setItem(MOOD_DB_KEY, JSON.stringify([]));
  }
}

// UPDATED: Sync existing moods to MySQL using your cycles table
async function syncExistingMoodsToMySQL() {
  try {
    const db = JSON.parse(localStorage.getItem(MOOD_DB_KEY)) || [];
    console.log('üîÑ Starting sync of', db.length, 'mood entries to MySQL');
    let syncedCount = 0;
    
    for (const entry of db) {
      if (!entry.mysqlId) {
        try {
          console.log('üì§ Syncing entry:', entry);
          
          // Create cycle entry for each mood/symptom
          const cycleData = {
            start_date: entry.date,
            end_date: entry.date,
            cycle_length: 28, // default
            symptoms: JSON.stringify([entry.mood]),
            mood: entry.category === "mood" ? entry.mood : "neutral",
            notes: `Category: ${entry.category}`
          };

          const response = await fetch('/api/cycles', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(cycleData)
          });
          
          console.log('üì• Sync response status:', response.status);
          
          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              entry.mysqlId = result.data.id;
              syncedCount++;
            }
          } else {
            console.error('‚ùå Sync failed for entry:', entry);
          }
        } catch (error) {
          console.error('üí• Error syncing entry:', error, entry);
        }
      }
    }
    
    // Update localStorage with MySQL IDs
    if (syncedCount > 0) {
      localStorage.setItem(MOOD_DB_KEY, JSON.stringify(db));
      console.log(`‚úÖ Successfully synced ${syncedCount} mood entries to MySQL`);
    } else {
      console.log('‚ÑπÔ∏è No new entries to sync to MySQL');
    }
  } catch (error) {
    console.error('üí• Error in syncExistingMoodsToMySQL:', error);
  }
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    weekday: 'long',
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
}

function formatTime(dateString) {
  const date = new Date(dateString);
  return date.toLocaleTimeString('en-US', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });
}

// UPDATED: Save mood to MySQL using cycles table
async function saveMood(date, mood, category = "mood") {
  try {
    console.log('üì§ Sending mood to MySQL:', { date, mood, category });
    
    // Prepare data for cycles table
    const cycleData = {
      start_date: date,
      end_date: date,
      cycle_length: 28, // default value
      symptoms: JSON.stringify([mood]),
      mood: category === "mood" ? mood : "neutral",
      notes: `Category: ${category}`
    };

    const response = await fetch('/api/cycles', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(cycleData)
    });

    console.log('üì• Response status:', response.status);
    
    if (!response.ok) {
      throw new Error(`Server returned ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    console.log('üì• Response data:', result);
    
    if (result.success) {
      const db = JSON.parse(localStorage.getItem(MOOD_DB_KEY)) || [];
      const now = new Date();
      const timestamp = now.toISOString();
      
      const moodData = {
        id: Date.now(),
        date: date,
        mood: mood,
        category: category,
        formattedDate: formatDate(date),
        timestamp: timestamp,
        formattedTime: formatTime(timestamp),
        mysqlId: result.data.id
      };
      
      db.push(moodData);
      localStorage.setItem(MOOD_DB_KEY, JSON.stringify(db));
      
      if (mood === "Positive" && !isPregnant) {
        isPregnant = true;
        const testDate = new Date(date);
        pregnancyDueDate = new Date(testDate);
        pregnancyDueDate.setDate(testDate.getDate() + 280);
        
        showPregnancyCelebration();
        renderCalendar();
      }
      
      updateLog();
      console.log('‚úÖ Mood saved successfully to MySQL');
      return db;
    } else {
      console.error('‚ùå Failed to save mood to server:', result.message);
      alert('Failed to save mood. Please try again.');
    }
  } catch (error) {
    console.error('üí• Error saving mood:', error);
    alert('Error saving mood. Please check your connection and try again.');
  }
}

function showPregnancyCelebration() {
  document.querySelector('.dashboard-header h1').innerHTML = 
    `<i class="fas fa-baby"></i> <%= username %>, Congratulations!`;
  document.querySelector('.dashboard-header p').textContent = 
    'Welcome to your pregnancy journey! Track your progress below.';
  
  const statsGrid = document.querySelector('.stats-grid');
  const daysUntilDue = Math.ceil((pregnancyDueDate - new Date()) / (24 * 60 * 60 * 1000));
  const weeksPregnant = Math.floor((280 - daysUntilDue) / 7);
  
  statsGrid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${daysUntilDue}</div>
      <div class="stat-label">Days until due date</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${weeksPregnant}</div>
      <div class="stat-label">Weeks pregnant</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${pregnancyDueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
      <div class="stat-label">Due date</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">2nd</div>
      <div class="stat-label">Trimester</div>
    </div>
  `;
  
  confetti({
    particleCount: 150,
    spread: 100,
    origin: { y: 0.6 },
    colors: ['#ff85a2', '#ff4785', '#e83f8e', '#9c4668']
  });
  
  setTimeout(() => {
    alert('üéâ Congratulations on your pregnancy! Your calendar has been updated to track your pregnancy journey. üéâ');
  }, 1000);
}

function getMoodsGroupedByDate() {
  const db = JSON.parse(localStorage.getItem(MOOD_DB_KEY)) || [];
  const grouped = {};
  const sortedEntries = db.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  sortedEntries.forEach(entry => {
    if (!grouped[entry.date]) grouped[entry.date] = [];
    grouped[entry.date].push(entry);
  });
  return grouped;
}

function deleteMoodEntry(id) {
  const db = JSON.parse(localStorage.getItem(MOOD_DB_KEY)) || [];
  const updatedDb = db.filter(entry => entry.id !== id);
  localStorage.setItem(MOOD_DB_KEY, JSON.stringify(updatedDb));
  updateLog();
}

function deleteMoodsForDate(date) {
  const db = JSON.parse(localStorage.getItem(MOOD_DB_KEY)) || [];
  const updatedDb = db.filter(entry => entry.date !== date);
  localStorage.setItem(MOOD_DB_KEY, JSON.stringify(updatedDb));
  updateLog();
}

function clearAllMoods() {
  if (confirm("Are you sure you want to clear all your mood history?")) {
    localStorage.setItem(MOOD_DB_KEY, JSON.stringify([]));
    isPregnant = false;
    pregnancyDueDate = null;
    updateLog();
    renderCalendar();
    
    document.querySelector('.dashboard-header h1').innerHTML = 
      `<%= username %>, Welcome to Your Cycle Dashboard`;
    document.querySelector('.dashboard-header p').textContent = 
      'Track your period, fertility, and symptoms all in one place';
  }
}

function updateLog() {
  logEntries.innerHTML = '';
  const groupedMoods = getMoodsGroupedByDate();

  if (Object.keys(groupedMoods).length === 0) {
    logEntries.innerHTML = '<div class="no-entries">No entries yet. Select a mood or symptom!</div>';
    return;
  }

  for (const date in groupedMoods) {
    const dayGroup = document.createElement('div');
    dayGroup.className = 'day-group';
    
    const dayHeader = document.createElement('div');
    dayHeader.className = 'day-header';
    dayHeader.innerHTML = `
      <span class="day-date">${groupedMoods[date][0].formattedDate}</span>
      <button class="day-clear" data-date="${date}">
        <i class="fas fa-times"></i> Clear
      </button>
    `;
    
    const moodsContainer = document.createElement('div');
    groupedMoods[date].forEach(mood => {
      const moodEntry = document.createElement('div');
      moodEntry.className = 'mood-entry';
      moodEntry.innerHTML = `
        <span class="mood-time">${mood.formattedTime}</span>
        <span class="mood-emoji">${mood.mood}</span>
        <button class="mood-delete" data-id="${mood.id}">
          <i class="fas fa-trash-alt"></i>
        </button>
      `;
      moodsContainer.appendChild(moodEntry);
    });
    
    dayGroup.appendChild(dayHeader);
    dayGroup.appendChild(moodsContainer);
    logEntries.appendChild(dayGroup);
  }

  document.querySelectorAll('.mood-delete').forEach(btn =>
    btn.addEventListener('click', () => deleteMoodEntry(parseInt(btn.dataset.id)))
  );

  document.querySelectorAll('.day-clear').forEach(btn =>
    btn.addEventListener('click', () => {
      if (confirm(`Clear all entries for ${formatDate(btn.dataset.date)}?`))
        deleteMoodsForDate(btn.dataset.date);
    })
  );
}

function setDefaultDate() {
  const today = new Date().toISOString().split('T')[0];
  dateInput.value = today;
  dateInput.max = today;
}

// Mood tracker event listeners
moodButtons.forEach(button => {
  button.addEventListener('click', () => {
    const selectedDate = dateInput.value;
    const mood = button.getAttribute('data-mood');
    
    if (!selectedDate) return alert("Please select a date first");
    
    let category = "mood";
    const parentSection = button.closest('.mood-selector').previousElementSibling;
    if (parentSection) {
      const sectionTitle = parentSection.textContent.toLowerCase();
      if (sectionTitle.includes('symptom')) category = "symptom";
      else if (sectionTitle.includes('discharge')) category = "discharge";
      else if (sectionTitle.includes('pregnancy')) category = "pregnancy_test";
      else if (sectionTitle.includes('physical')) category = "physical_activity";
    }
    
    saveMood(selectedDate, mood, category);

    button.style.transform = 'scale(1.2)';
    setTimeout(() => button.style.transform = '', 200);

    if (mood === "üòä" || mood === "Everything is Fine") {
      confetti({
        particleCount: 80,
        spread: 60,
        origin: { y: 0.6 },
        colors: ['#ff85a2', '#ff4785', '#e83f8e']
      });
    }
  });
});

clearBtn.addEventListener('click', clearAllMoods);
  </script>
</body>
</html>
  

        