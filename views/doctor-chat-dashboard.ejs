<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Chat - BloomCycle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #e83f8e;
            --primary-light: #ff8fab;
            --primary-lighter: #ffc2d1;
            --secondary: #9c4668;
            --light: #fff9fb;
            --white: #ffffff;
            --text: #3a2e37;
            --bloom: linear-gradient(135deg, #e83f8e, #ff8fab);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --success: #4CAF50;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light); min-height: 100vh; }

        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding: 1.5rem; background: var(--white); border-radius: 15px; box-shadow: var(--shadow); }
        .header h1 { color: var(--primary); font-weight: 700; margin: 0; }
        
        .doctor-info { display: flex; align-items: center; gap: 15px; }
        .doctor-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--bloom); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        
        .section-card { background: var(--white); border-radius: 15px; padding: 1.5rem; box-shadow: var(--shadow); }
        .section-header { color: var(--primary); font-weight: 600; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary-lighter); }
        
        .chat-container { display: flex; flex-direction: column; height: 600px; }
        .conversations-list { max-height: 400px; overflow-y: auto; }
        .conversation-item { padding: 1rem; border-bottom: 1px solid var(--primary-lighter); cursor: pointer; transition: all 0.3s ease; }
        .conversation-item:hover { background: var(--primary-lighter); }
        .conversation-item.active { background: var(--primary-lighter); border-left: 4px solid var(--primary); }
        
        .chat-area { display: flex; flex-direction: column; height: 500px; border: 1px solid var(--primary-lighter); border-radius: 10px; overflow: hidden; }
        .chat-messages { flex: 1; padding: 1rem; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column; }
        .chat-input-area { display: flex; gap: 10px; padding: 1rem; background: var(--white); border-top: 1px solid var(--primary-lighter); }
        .chat-input { flex: 1; padding: 0.75rem; border: 1px solid var(--primary-lighter); border-radius: 25px; }
        .send-btn { background: var(--bloom); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; }
        .send-btn:hover { transform: scale(1.05); }
        .send-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        .message { max-width: 80%; padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 15px; word-wrap: break-word; }
        .message.user { align-self: flex-start; background: var(--white); border: 1px solid var(--primary-lighter); }
        .message.doctor { align-self: flex-end; background: var(--bloom); color: white; }
        
        .unread-badge { background: var(--primary); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem; }
        
        .message-time { font-size: 0.7rem; opacity: 0.7; margin-top: 5px; }
        
        .no-conversations { text-align: center; padding: 2rem; color: var(--secondary); }
        .no-conversations i { font-size: 3rem; margin-bottom: 1rem; color: var(--primary-lighter); }
        
        .alert-error { 
            background: #f8d7da; 
            color: #721c24; 
            padding: 0.75rem; 
            border-radius: 8px; 
            margin-bottom: 1rem; 
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-user-md me-2"></i>Doctor Portal - Chat</h1>
            <div class="doctor-info">
                <div class="doctor-avatar">DR</div>
                <div>
                    <h4 class="mb-0"><%= doctorName %></h4>
                    <p class="mb-0 text-muted"><%= doctorSpecialization %></p>
                </div>
                <a href="/doctor/dashboard" class="btn btn-outline-primary me-2">Back to Dashboard</a>
                <a href="/logout" class="btn btn-outline-primary">Log Out</a>
            </div>
        </div>

        <div class="dashboard">
            <!-- Chat Conversations Section -->
            <div class="section-card">
                <h3 class="section-header"><i class="fas fa-comments me-2"></i>Private Chats</h3>
                <div class="chat-container">
                    <div class="conversations-list" id="conversationsList">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading conversations...</p>
                        </div>
                    </div>
                </div>
            </div>

           <!-- Chat Area -->
<div class="section-card">
    <h3 class="section-header"><i class="fas fa-comment-dots me-2"></i>Chat</h3>
    <div class="chat-area">
        <!-- Error alert div -->
        <div id="errorAlert" class="alert-error" style="display: none;"></div>
        <div class="chat-messages" id="chatMessages">
            <div class="text-center text-muted py-4">
                <i class="fas fa-user-md fa-2x mb-2"></i>
                <p>Select a conversation to start chatting</p>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." disabled>
            <button class="send-btn" id="sendBtn" disabled>
                <i class="fas fa-paper-plane"></i> Send
            </button>
        </div>
    </div>
</div>
        </div>
    </div>

    <script>
    let currentUserId = null;
    let currentUserName = null;
    let refreshInterval = null;

    // Load conversations
    async function loadConversations() {
        try {
            const response = await fetch('/api/doctor/chat/messages');
            const result = await response.json();
            
            if (result.success) {
                displayConversations(result.data);
            } else {
                showError('Failed to load conversations: ' + (result.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error loading conversations:', error);
            showError('Network error loading conversations');
        }
    }

    function displayConversations(conversations) {
        const container = document.getElementById('conversationsList');
        
        if (conversations.length === 0) {
            container.innerHTML = `
                <div class="no-conversations">
                    <i class="fas fa-comments"></i>
                    <p>No active conversations</p>
                    <small>When users message you, they will appear here.</small>
                </div>
            `;
            return;
        }

        container.innerHTML = conversations.map(conv => {
            // Escape the user name to prevent XSS and SQL injection in the onclick
            const safeUserName = conv.user_name.replace(/'/g, "\\'").replace(/"/g, '\\"');
            return `
            <div class="conversation-item" onclick="selectConversation(${conv.user_id}, '${safeUserName}')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${conv.user_name}</strong>
                        <div class="text-muted small">Last: ${new Date(conv.last_message_time).toLocaleString()}</div>
                    </div>
                    ${conv.unread_count > 0 ? `<span class="unread-badge">${conv.unread_count} unread</span>` : ''}
                </div>
            </div>
            `;
        }).join('');
    }

    async function selectConversation(userId, userName) {
        try {
            console.log('Selecting conversation with user:', userId, userName);
            
            if (!userId) {
                showError('Invalid user selected');
                return;
            }
            
            currentUserId = userId;
            currentUserName = userName;
            
            // Update UI - safely remove active class from all items
            const conversationItems = document.querySelectorAll('.conversation-item');
            conversationItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item - safely check for event
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            // FIXED: Update the correct header - look for the chat area header specifically
            const chatHeader = document.querySelector('.section-card:nth-child(2) .section-header');
            if (chatHeader) {
                chatHeader.innerHTML = `<i class="fas fa-comment-dots me-2"></i>Chat with ${userName}`;
            } else {
                console.warn('Chat header not found');
            }
            
            // Enable chat inputs
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            if (chatInput) chatInput.disabled = false;
            if (sendBtn) sendBtn.disabled = false;
            if (chatInput) chatInput.focus();
            
            // Clear previous errors
            hideError();
            
            // Load messages
            await loadMessages(userId);
            
            // Start auto-refresh
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => loadMessages(userId), 3000);
            
        } catch (error) {
            console.error('Error in selectConversation:', error);
            showError('Error selecting conversation: ' + error.message);
        }
    }

    async function loadMessages(userId) {
        try {
            console.log('Loading messages for user:', userId);
            const response = await fetch(`/api/doctor/chat/messages/${userId}`);
            const result = await response.json();
            
            if (result.success) {
                displayMessages(result.data);
            } else {
                showError('Failed to load messages: ' + (result.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error loading messages:', error);
            // Don't show error for auto-refresh, only for initial load
            if (!refreshInterval) {
                showError('Network error loading messages');
            }
        }
    }

    function displayMessages(messages) {
        const container = document.getElementById('chatMessages');
        
        if (!messages || messages.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-comments fa-2x mb-2"></i>
                    <p>No messages yet</p>
                    <small>Start the conversation with this user</small>
                </div>
            `;
            return;
        }

        container.innerHTML = messages.map(msg => {
            const messageTime = new Date(msg.created_at).toLocaleString();
            const isDoctor = msg.sender_type === 'doctor';
            const senderName = isDoctor ? 'You' : (msg.user_name || 'User');
            
            return `
            <div class="message ${isDoctor ? 'doctor' : 'user'}">
                <div class="fw-bold">${senderName}</div>
                <div>${msg.message || ''}</div>
                <div class="message-time">${messageTime}</div>
            </div>
            `;
        }).join('');
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message || !currentUserId) {
            showError('Please enter a message');
            return;
        }
        
        // Disable input while sending
        input.disabled = true;
        document.getElementById('sendBtn').disabled = true;
        
        try {
            const response = await fetch('/api/doctor/chat/send-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUserId,
                    message: message
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                input.value = '';
                await loadMessages(currentUserId);
                await loadConversations(); // Refresh conversation list
            } else {
                showError(result.message || 'Failed to send message');
            }
        } catch (error) {
            console.error('Error sending message:', error);
            showError('Network error sending message');
        } finally {
            input.disabled = false;
            document.getElementById('sendBtn').disabled = false;
            input.focus();
        }
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorAlert');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Auto-hide error after 5 seconds
            setTimeout(hideError, 5000);
        } else {
            console.error('Error (no error div):', message);
        }
    }

    function hideError() {
        const errorDiv = document.getElementById('errorAlert');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        const sendBtn = document.getElementById('sendBtn');
        const chatInput = document.getElementById('chatInput');
        
        if (sendBtn) {
            sendBtn.addEventListener('click', sendMessage);
        }
        
        if (chatInput) {
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }
        
        // Initialize
        loadConversations();
        setInterval(loadConversations, 5000); // Refresh conversations every 5 seconds
    });
</script>
</body>
</html>